name: Generate Swagger UI Documentation

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/openapi.json'   # openapi.json ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
  workflow_dispatch:          # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  build-swagger-ui:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify openapi.json exists
        run: |
          if [ ! -f "docs/openapi.json" ]; then
            echo "âŒ docs/openapi.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "âœ… openapi.json íŒŒì¼ í™•ì¸ë¨"

      - name: Validate OpenAPI spec
        run: |
          pip install openapi-spec-validator
          openapi-spec-validator docs/openapi.json
          echo "âœ… OpenAPI ìŠ¤í™ ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼"

      - name: Download Swagger UI (via npm)
        run: |
          echo "ğŸ”½ Swagger UI ì„¤ì¹˜ ì¤‘..."
          npm install swagger-ui-dist
          mkdir -p deploy
          cp -r node_modules/swagger-ui-dist/* deploy/
          echo "âœ… Swagger UI ì„¤ì¹˜ ì™„ë£Œ"

      - name: Configure Swagger UI
        run: |
          echo "âš™ï¸ Swagger UI ì„¤ì • ì¤‘..."

          # openapi.json ë³µì‚¬
          cp docs/openapi.json deploy/

          # swagger-initializer.js ìˆ˜ì • (ê¸°ë³¸ Petstore â†’ ìš°ë¦¬ API)
          sed -i 's|https://petstore.swagger.io/v2/swagger.json|./openapi.json|g' deploy/swagger-initializer.js

          # í˜ì´ì§€ ì œëª© ë³€ê²½
          sed -i 's|<title>Swagger UI</title>|<title>Item Management API</title>|g' deploy/index.html

          # í—¤ë” ì¶”ê°€ (ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥)
          sed -i 's|<div id="swagger-ui"></div>|<div style="text-align:center; padding:20px;"><h1>ğŸ›ï¸ Item Management API</h1></div><div id="swagger-ui"></div>|g' deploy/index.html
          
          # YAML ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¶”ê°€
          cp docs/openapi.json deploy/openapi.yaml
          sed -i '/<div id="swagger-ui"><\/div>/i <div style="text-align:right; margin:10px;"><a href="./openapi.yaml" download>ğŸ“„ Download OpenAPI YAML</a></div>' deploy/index.html

          echo "âœ… Swagger UI ì„¤ì • ì™„ë£Œ"

      - name: Create README
        run: |
          cat > deploy/README.md << EOF
          # Item Management API Documentation
          
          ì´ í˜ì´ì§€ëŠ” GitHub Actionsë¥¼ í†µí•´ ìë™ ìƒì„±ë©ë‹ˆë‹¤.
          
          ## ğŸ“‹ API ë¬¸ì„œ
          - **Swagger UI**: [ì—¬ê¸°ì„œ í™•ì¸](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)
          - **OpenAPI Spec**: [openapi.json](./openapi.json)
          
          ## ğŸ”„ ì—…ë°ì´íŠ¸ ë°©ë²•
          1. ë¡œì»¬ì—ì„œ \`docs/openapi.json\` íŒŒì¼ ìƒì„±
          2. Git push
          3. GitHub Actionsê°€ ìë™ìœ¼ë¡œ ë¬¸ì„œ ìƒì„± ë° ë°°í¬
          
          ## ğŸ“… ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸
          $(date)
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          commit_message: "ğŸš€ Update API documentation from ${{ github.sha }}"

      - name: Summary
        run: |
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“– ë¬¸ì„œ URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "ğŸ” í™•ì¸ì‚¬í•­:"
          echo "1. GitHub Repository â†’ Settings â†’ Pagesì—ì„œ Sourceë¥¼ 'gh-pages' ë¸Œëœì¹˜ë¡œ ì„¤ì •"
          echo "2. ì•½ 1-2ë¶„ í›„ ë¬¸ì„œ ì ‘ê·¼ ê°€ëŠ¥"
